<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatPing Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .glass { background: #1e293b; border: 1px solid #334155; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-md mx-auto">
        <!-- HEADER -->
        <nav class="flex justify-between items-center border-b border-slate-800 pb-4 mb-6">
            <div class="text-sky-400 font-bold flex items-center gap-2">
                <i data-lucide="zap"></i> ChatPing
            </div>
            <div id="statusDot" class="flex items-center gap-2 text-[10px] font-bold uppercase text-slate-500">
                <span class="w-2 h-2 rounded-full bg-red-500"></span> <span id="statusLabel">Offline</span>
            </div>
        </nav>

        <!-- ID GENERATION BOX -->
        <div id="setup-box" class="glass p-6 rounded-2xl text-center mb-6">
            <h1 class="text-xl font-bold mb-2">Local Endpoint</h1>
            <p class="text-slate-400 text-xs mb-4">Your ID for others to connect to you:</p>
            <div class="bg-slate-950 p-3 rounded-lg flex items-center justify-between gap-2 border border-slate-800">
                <code id="myId" class="text-sky-400 font-mono text-sm">GENERATING...</code>
                <button onclick="copyId()" class="text-slate-500 hover:text-white"><i data-lucide="copy" class="w-4 h-4"></i></button>
            </div>
            <div id="error-msg" class="text-red-400 text-[10px] mt-2 hidden">Connection blocked by network/firewall.</div>
        </div>

        <!-- ACTION TABS -->
        <div class="flex gap-2 mb-6">
            <button onclick="switchTab('join')" class="flex-1 bg-slate-800 py-2 rounded-lg text-sm font-bold">Join Peer</button>
            <button onclick="switchTab('chat')" id="chat-tab-btn" class="flex-1 bg-slate-800 py-2 rounded-lg text-sm font-bold opacity-50 cursor-not-allowed" disabled>Chat Room</button>
        </div>

        <!-- JOIN PAGE -->
        <div id="page-join" class="">
            <div class="glass p-6 rounded-2xl">
                <h2 class="font-bold mb-4">Connect to Friend</h2>
                <input id="remoteId" type="text" placeholder="Paste Friend's ID" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm mb-4 outline-none focus:border-sky-500">
                <button onclick="connectToPeer()" class="w-full bg-sky-500 text-slate-900 font-bold p-3 rounded-lg hover:bg-sky-400 transition">Establish Link</button>
            </div>
        </div>

        <!-- CHAT PAGE -->
        <div id="page-chat" class="hidden">
            <div class="glass rounded-2xl h-96 flex flex-col overflow-hidden">
                <div id="messages" class="flex-1 p-4 overflow-y-auto space-y-3 text-sm">
                    <div class="text-slate-500 text-center italic mt-10">Waiting for first message...</div>
                </div>
                <div class="p-3 border-t border-slate-800 flex gap-2">
                    <input id="chatInput" type="text" placeholder="Message..." class="flex-1 bg-transparent outline-none text-sm" onkeypress="if(event.key==='Enter') send()">
                    <button onclick="send()" class="text-sky-400"><i data-lucide="send"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use a random ID to avoid collisions and 0.peerjs.com default
        const peer = new Peer(Math.random().toString(36).substr(2, 6), {
            debug: 2,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        let conn;

        peer.on('open', id => {
            document.getElementById('myId').innerText = id;
            document.getElementById('statusLabel').innerText = 'Online';
            document.getElementById('statusDot').querySelector('span').className = 'w-2 h-2 rounded-full bg-green-500';
            document.getElementById('error-msg').classList.add('hidden');
        });

        peer.on('error', err => {
            console.error(err);
            document.getElementById('error-msg').innerText = "ERROR: " + err.type;
            document.getElementById('error-msg').classList.remove('hidden');
        });

        // Receiving a connection
        peer.on('connection', c => {
            conn = c;
            initChat();
        });

        function connectToPeer() {
            const id = document.getElementById('remoteId').value;
            if(!id) return alert("Enter ID");
            conn = peer.connect(id);
            initChat();
        }

        function initChat() {
            conn.on('open', () => {
                document.getElementById('chat-tab-btn').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('chat-tab-btn').disabled = false;
                switchTab('chat');
                document.getElementById('statusLabel').innerText = 'Connected';
            });
            conn.on('data', data => addMessage('Peer', data));
        }

        function send() {
            const input = document.getElementById('chatInput');
            if(conn && input.value) {
                conn.send(input.value);
                addMessage('You', input.value);
                input.value = '';
            }
        }

        function addMessage(user, text) {
            const box = document.getElementById('messages');
            if(box.innerText.includes('Waiting')) box.innerHTML = '';
            const msg = `<div class="${user === 'You' ? 'text-right' : 'text-left'}">
                <span class="text-[9px] text-sky-500 uppercase font-bold">${user}</span>
                <div class="p-2 rounded-lg mt-1 inline-block ${user === 'You' ? 'bg-sky-600' : 'bg-slate-700'}">${text}</div>
            </div>`;
            box.innerHTML += msg;
            box.scrollTop = box.scrollHeight;
        }

        function switchTab(tab) {
            document.getElementById('page-join').classList.toggle('hidden', tab !== 'join');
            document.getElementById('page-chat').classList.toggle('hidden', tab !== 'chat');
        }

        function copyId() {
            navigator.clipboard.writeText(document.getElementById('myId').innerText);
            alert("ID Copied");
        }

        lucide.createIcons();
    </script>
</body>
</html>
